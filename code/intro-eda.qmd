---
title: "Introduction + EDA"
author: "Aditya Iyer"
date: "2024-11-01"
format: pdf
editor: source
---





# Loading in package
```{r}
library(here)
library(tidyverse)
library(ggrepel)
library(nflreadr)
library(nflplotR)
library(tidymodels)
tidymodels_prefer()

options(scipen = 9999)
options(nflreadr.verbose = FALSE)
```



# EDA

First, working with just one year: 2016

```{r}
pbp_2016 <- load_pbp(2016)
```


## Filtering Important Columns 

Manually selecting all relevant seeming columns from the column dictionary (https://www.nflfastr.com/articles/field_descriptions.html)
```{r}
pbp_mod_2016 <- pbp_2016 |> 
  select(aborted_play, air_epa, air_wpa, air_yards, assist_tackle, away_score, away_team, away_timeouts_remaining, away_wp, away_wp_post, comp_air_epa, comp_air_wpa, comp_yac_epa, comp_yac_wpa, complete_pass, cp, cpoe, def_wp, defensive_extra_point_attempt, defensive_extra_point_conv, defensive_two_point_attempt, defensive_two_point_conv, defteam, defteam_score, defteam_score_post, defteam_timeouts_remaining, desc, div_game, down, drive, drive_end_transition, drive_end_yard_line, drive_ended_with_score, drive_first_downs, drive_game_clock_start, drive_game_clock_end, drive_inside20, drive_play_count, drive_play_id_ended, drive_play_id_started, drive_quarter_start,drive_quarter_end, drive_start_transition, drive_start_yard_line, drive_time_of_possession, drive_yards_penalized, end_clock_time, end_yard_line, ep, epa, extra_point_attempt, extra_point_prob, extra_point_result, fantasy, fg_prob, field_goal_result, field_goal_attempt, first_down, first_down_pass, first_down_penalty, first_down_rush, fixed_drive, fixed_drive_result, fourth_down_converted, fourth_down_failed, fumble, fumble_forced, fumble_lost, fumble_not_forced, fumble_out_of_bounds, game_half, game_id, game_seconds_remaining, goal_to_go, half_seconds_remaining, home_opening_kickoff, home_score, home_team, home_timeouts_remaining, home_wp, home_wp_post, incomplete_pass, interception, kick_distance, kickoff_attempt, kickoff_downed, kickoff_fair_catch, kickoff_in_endzone, kickoff_inside_twenty, kickoff_out_of_bounds, lateral_receiving_yards, lateral_reception, lateral_recovery, lateral_return, lateral_rush, lateral_rushing_yards, no_huddle, no_score_prob, opp_fg_prob, opp_safety_prob, opp_td_prob, out_of_bounds, own_kickoff_recovery, own_kickoff_recovery_td, pass, pass_attempt, pass_length, pass_oe, pass_touchdown, passing_yards, penalty, penalty_team, penalty_type, penalty_yards, play, play_deleted, play_id, play_type, play_type_nfl, posteam, posteam_score, posteam_score_post, posteam_timeouts_remaining, posteam_type, punt_attempt, punt_blocked, punt_downed, punt_fair_catch, punt_in_endzone, punt_inside_twenty, punt_out_of_bounds, qb_dropback, qb_epa, qb_hit,qb_kneel, qb_scramble, qb_spike, qtr, quarter_end, quarter_seconds_remaining,replay_or_challenge, replay_or_challenge_result, result, return_team, return_touchdown, return_yards, roof, run_gap, rush, rush_attempt, rush_touchdown,sack,safety, safety_prob, score_differential, score_differential_post, season, season_type, series, series_result, series_success, shotgun, side_of_field, sp, special, special_teams_play, spread_line, st_play_type, start_time, success, surface, tackled_for_loss, td_prob, td_team, temp, third_down_converted, third_down_failed, time, time_of_day, timeout, timeout_team, total, total_away_comp_air_epa, total_away_comp_air_wpa, total_away_comp_yac_epa, total_away_comp_yac_wpa, total_away_epa, total_away_pass_epa, total_away_pass_wpa, total_away_raw_air_epa, total_away_raw_air_wpa, total_away_raw_yac_epa, total_away_raw_yac_wpa, total_away_rush_epa, total_away_rush_wpa, total_away_score, total_home_comp_air_epa, total_home_comp_air_wpa, total_home_comp_yac_epa, total_home_comp_yac_wpa, total_home_epa, total_home_pass_epa, total_home_pass_wpa, total_home_raw_air_epa, total_home_raw_air_wpa, total_home_raw_yac_epa, total_home_raw_yac_wpa, total_home_rush_epa, total_home_rush_wpa, total_home_score, total_line, touchback, touchdown, two_point_attempt, two_point_conv_result, two_point_conversion_prob, weather, wp, wpa, xpass, xyac_epa, xyac_fd, xyac_mean_yardage, xyac_median_yardage, xyac_success, yac_epa, yac_wpa, yardline_100, yards_after_catch, yards_gained, ydsnet, ydstogo, yrdln, solo_tackle)
```


## Basic Definitions

*EPA*: Expected points added
Context-sensitive, measures impact of a play on expected points team will score on that drive. It considers the down, distance, and field position to estimate how many points the offense is likely to score, then compares that estimate before and after the play.

*WPA*: Win probability added 
WPA measures how much a play changes a teamâ€™s chances of winning the game. It takes into account the time remaining, score differential, field position, and down and distance to estimate the probability of winning before and after the play.


Now, going through data columns and aggregating/combining columns that may cover the same information

```{r}
pbp_fil_2016 <- pbp_mod_2016 |> 
   mutate(tackle = if_else(solo_tackle == 1 | assist_tackle == 1, 1, 0),
          first_down_result = case_when(
            first_down_pass == 1 ~ "pass",
            first_down_rush == 1 ~ "rush",
            first_down_penalty == 1 ~ "penalty"
          ),
          fourth_down_result = case_when(
            fourth_down_converted == 1 ~ "converted",
            fourth_down_failed == 1 ~ "failed"
          ),
          touchdown_result = case_when(
            pass_touchdown == 1 ~ "pass",
            return_touchdown == 1 ~ "return",
            rush_touchdown == 1 ~ "rush",
            touchdown == 1 ~ "other"
          )) |> 
  select(-assist_tackle, -first_down, -first_down_pass, -first_down_penalty, -first_down_rush, -fourth_down_converted, -fourth_down_failed, -pass_touchdown, -return_touchdown, -rush_touchdown, -touchdown)
```






# EDA

Working just with one game (Patriots - Falcons 2016 Super Bowl)
```{r}
sb_2016 <- pbp_fil_2016 |> 
  filter(game_id== "2016_21_NE_ATL") |> 
  select(-temp, -roof, -surface, -weather, season, -season_type, start_time, time_of_day, -pass_length, -kickoff_in_endzone, -kickoff_downed, -time, )
```

Can I further aggregate columns? Check on a specific game basis:


Key variables for defining momentum:

**drive_first_downs**
**drive_play_count**
**drive_time_of_possession**
**drive_yards_penalized**
**quarter_end**
**qtr**
**yards_gained**
**game_seconds_remaining**
**half_seconds_remaining**
**twp_point_attempt**
**two_point_conversion_prob**
**drive_inside20**
**drive_ended_with_score**
**home_wp_post**
**away_wp_post**
**score_differential**
**score_differential_post**
**success**
**total_home_epa**
**total_away_epa**
**fourth_down_result**
**third_down_converted**
**turnover**
**play_type**
**posteam_type**: String indicating whether the posteam team is home or away.



```{r}
sb_2016 <- sb_2016 |> 
  mutate(play_id = row_number() - 1) |> # Make play ID in regular order counting the plays, will have to change to be game-specific for larger datasets
  mutate(home_score_diff = if_else(posteam_type == "home", score_differential, -score_differential)) # Create home_score_diff, home_score - away_score
```


What I need is rolling metrics. One by one let me identify these rolling metrics that are important:

Last 3 drives result: Some sort of spectrum, from 3 Scores being highest momentum to 3 turnovers being the worst




Write sb_2016 into its own file for further exploration
```{r}
write_csv(sb_2016, here::here("data/sb_2016.csv"))
```




